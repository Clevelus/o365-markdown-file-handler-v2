<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Invoke File Handler</title>
</head>
<body>
  <table border="0">
    <tr>
      <td>File handler action</td>
      <td><select name="actionSelector" id="actionSelector">
        <!-- Change the value of each option to the path of your file handler receiver -->
        <option value="/filehandler/converttopdf">Convert to PDF</option>
        <option value="/filehandler/compressfiles">Compress Files</option>
        <option value="/filehandler/open" selected>Open</option>
        <option value="/filehandler/preview">Preview</option>
        <option value="/filehandler/newfile">New File</option>
        <option value="/filehandler/edit">Edit</option>
        <option value="/filehandler/save">Save</option>
      </select></td>
    </tr>
    </table>

    <form action="/filehandler/open" method="post" target="_blank" id="post1">
      <table border="0">
        <tr>
          <td>Culture Name</td>
          <td><input type="text" name="cultureName" value="en-us" /></td>
        </tr>
        <tr>
          <td>Client</td>
          <td><input type="text" name="client" value="OneDrive" /></td>
        </tr>
        <tr>
          <td>Item URL</td>
          <td><input type="text" name="item" value="" id="item" style="width: 724px" /><button onclick="return getItemUrl()">Get URL</button></td>
        </tr>
        <tr>
          <td>User Id</td>
          <td><input type="text" name="userId" value="{cbc0d6bd-0d9f-4c42-86ed-2d736b2bc80c}{b26fc4a8-3bfb-4a01-a0df-6e0eeb222867}" style="width: 520px" /></td>
        </tr>
        <tr>
          <td colspan="2"><input type="submit" value="POST!" /></td>
        </tr>
      </table>

    </form>
</body>
</html>

<script language="javascript">
  function updateFormActionTarget() {
    document.getElementById("post1").action = document.getElementById("actionSelector").value;
  }
  document.getElementById("actionSelector").onchange = updateFormActionTarget;

  var OneDriveDebug = { debug: true };

  function getItemUrl() {

    var pickerOptions = {
      linkType: "webLink",
      multiSelect: false,
      openInNewWindow: true,
      success: function (files) {
        var sharingLink = files.values[0].link;
        var accessToken = files.values[0].accessToken;
        var origin = getUrlOrigin(sharingLink);
        var link = origin + "/_api/v2.0/shares/u!" + window.btoa(sharingLink).trimRight('=').replace('/', '_').replace('+', '-') + "/root?access_token=" + accessToken;
        document.getElementById("item").value = link;
      }
    };

    

    function getUrlOrigin(url) {
      var parser = document.createElement("a");
      parser.href = url;
      return parser.origin;
    }

    OneDrive.open(pickerOptions);
    return false;
  }
</script>

<script type="text/javascript" src="OneDrive6.debug.js" id="onedrive-js" client-id="db0eff9c-61cd-491c-99fc-5b20f75bd8c9"></script>
